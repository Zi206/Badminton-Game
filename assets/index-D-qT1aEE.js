var x=Object.defineProperty;var C=(d,t,s)=>t in d?x(d,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):d[t]=s;var n=(d,t,s)=>C(d,typeof t!="symbol"?t+"":t,s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))h(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&h(o)}).observe(document,{childList:!0,subtree:!0});function s(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function h(i){if(i.ep)return;i.ep=!0;const a=s(i);fetch(i.href,a)}})();const e={CANVAS_WIDTH:800,CANVAS_HEIGHT:500,BOUNDARY_LEFT:0,BOUNDARY_RIGHT:800,BOUNDARY_TOP:0,GRAVITY:.55,BALL_GRAVITY:.4,BALL_AIR_RESISTANCE:.98,GROUND_Y:410,BALL_GROUND_Y:450,NET_X:400,NET_HEIGHT:100,NET_BASE_Y:410,SERVICE_LINE_LEFT:350,SERVICE_LINE_RIGHT:450,PLAYER_HEIGHT:90,PLAYER_WIDTH:22,PLAYER_SPEED:5,HIT_RANGE:65,PLAYER1_X:170,PLAYER2_X:630,BALL_RADIUS:9,BALL_INITIAL_Y:200,RACKET_HEAD_WIDTH:12,RACKET_HEAD_HEIGHT:36,RACKET_SHAFT_LENGTH:20,RACKET_SHAFT_RADIUS:1.5,RACKET_HANDLE_LENGTH:15,SWING_UPWARD_START:-Math.PI*3/4,SWING_UPWARD_END:-Math.PI*7/4,SWING_DOWNWARD_START:-Math.PI*3/4,SWING_DOWNWARD_END:0,SWING_UPWARD_DURATION:18,SWING_DOWNWARD_DURATION:20,SERVING_ANIMATION_DURATION:10,AI_REACTION_DELAY:150,PARTICLE_COUNT:6,PARTICLE_LIFETIME:20,WINNING_SCORE:10,LEG_ANIMATION_SPEED:.25,LEFT_BOUNDARY:30,RIGHT_BOUNDARY:770};var _=(d=>(d[d.LOADING=0]="LOADING",d[d.MENU=1]="MENU",d[d.PLAYING=2]="PLAYING",d[d.GAME_OVER=3]="GAME_OVER",d))(_||{}),A=(d=>(d[d.LEFT=0]="LEFT",d[d.RIGHT=1]="RIGHT",d))(A||{});class G{constructor(){n(this,"resources",new Map);n(this,"loadingPromises",[])}loadImage(t,s){const h=new Image,i=new Promise((a,o)=>{h.onload=()=>{this.resources.set(t,h),console.log(`‚úì ËµÑÊ∫êÂä†ËΩΩÊàêÂäü: ${t}`),a()},h.onerror=()=>{console.warn(`‚úó ËµÑÊ∫êÂä†ËΩΩÂ§±Ë¥•: ${t}Ôºå‰ΩøÁî®Âç†‰ΩçÁ¨¶`);const r=document.createElement("canvas");r.width=100,r.height=100;const l=r.getContext("2d");l.fillStyle="#D2691E",l.fillRect(0,0,100,100),l.strokeStyle="#8B4513",l.lineWidth=2,l.strokeRect(0,0,100,100);const c=new Image;c.src=r.toDataURL(),c.onload=()=>{this.resources.set(t,c),a()}},h.src=s});this.loadingPromises.push(i)}async waitForAll(){await Promise.all(this.loadingPromises),console.log(`ÊâÄÊúâËµÑÊ∫êÂä†ËΩΩÂÆåÊàê (${this.resources.size}‰∏™)`)}getImage(t){return this.resources.get(t)||null}hasImage(t){return this.resources.has(t)}}class Y{constructor(t,s){n(this,"ctx");n(this,"backgroundCache",null);this.canvas=t,this.resourceManager=s,this.ctx=t.getContext("2d"),this.canvas.width=e.CANVAS_WIDTH,this.canvas.height=e.CANVAS_HEIGHT,this.ctx.imageSmoothingEnabled=!1}cacheBackground(){if(this.backgroundCache)return;this.backgroundCache=document.createElement("canvas"),this.backgroundCache.width=this.canvas.width,this.backgroundCache.height=this.canvas.height;const t=this.backgroundCache.getContext("2d");t.imageSmoothingEnabled=!1;const s=this.resourceManager.getImage("background");if(s)t.drawImage(s,0,0,this.canvas.width,this.canvas.height);else{t.fillStyle="#D2691E",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.strokeStyle="rgba(139, 69, 19, 0.3)",t.lineWidth=2;for(let h=0;h<this.canvas.width;h+=30)t.beginPath(),t.moveTo(h,0),t.lineTo(h,this.canvas.height),t.stroke()}t.strokeStyle="rgba(0, 0, 0, 0.2)",t.lineWidth=2,t.beginPath(),t.moveTo(0,e.GROUND_Y),t.lineTo(this.canvas.width,e.GROUND_Y),t.stroke()}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}renderBackground(){this.backgroundCache||this.cacheBackground(),this.backgroundCache&&this.ctx.drawImage(this.backgroundCache,0,0)}renderScoreboard(t,s){const h=this.resourceManager.getImage("score_bg"),i=this.canvas.width/2,a=260,o=90;h?this.ctx.drawImage(h,i-a/2,15,a,o):(this.ctx.fillStyle="#FFFACD",this.ctx.strokeStyle="#DAA520",this.ctx.lineWidth=2,this.ctx.save(),this.ctx.translate(i,50),this.ctx.rotate(-.02),this.ctx.fillRect(-a/2,-o/2,a,o),this.ctx.strokeRect(-a/2,-o/2,a,o),this.ctx.restore()),this.ctx.font='bold 32px "Permanent Marker", cursive',this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle="#000000ff",this.ctx.fillText(t.toString(),i-50,60),this.ctx.strokeStyle="#ffffffff",this.ctx.lineWidth=1,this.ctx.strokeText(t.toString(),i-50,60),this.ctx.fillText("-",i,60),this.ctx.strokeText("-",i,60),this.ctx.fillText(s.toString(),i+50,60),this.ctx.strokeText(s.toString(),i+50,60)}renderPlayerNames(){this.ctx.textAlign="center",this.ctx.textBaseline="top";const t=this.resourceManager.getImage("label_bg");t&&(this.ctx.drawImage(t,130-100/2,90,100,40),this.ctx.save(),this.ctx.translate(670,90+40/2),this.ctx.scale(-1,1),this.ctx.drawImage(t,-100/2,-40/2,100,40),this.ctx.restore()),this.ctx.font='14px "Permanent Marker", cursive',this.ctx.fillStyle="#000000ff",this.ctx.fillText("Áé©ÂÆ∂ 1",130,103),this.ctx.font='14px "Permanent Marker", cursive',this.ctx.fillStyle="#000000ff",this.ctx.fillText("AI",670,103)}renderServeHint(){this.ctx.font='16px "Permanent Marker", cursive',this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle="#FFD700",this.ctx.strokeStyle="#000",this.ctx.lineWidth=3;const t="ÊåâSÈîÆÂèëÁêÉ";this.ctx.strokeText(t,130,180),this.ctx.fillText(t,130,180)}renderGameOver(t){this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.font='bold 48px "Permanent Marker", cursive',this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle="#FFD700",this.ctx.strokeStyle="#000",this.ctx.lineWidth=4;const s=this.canvas.height/2;this.ctx.strokeText(`${t} Ëé∑ËÉú!`,this.canvas.width/2,s-30),this.ctx.fillText(`${t} Ëé∑ËÉú!`,this.canvas.width/2,s-30),this.ctx.font='16px "Permanent Marker", cursive',this.ctx.fillStyle="#FFFFFF",this.ctx.fillText("ÊåâÁ©∫Ê†ºÈîÆÈáçÊñ∞ÂºÄÂßã",this.canvas.width/2,s+30)}renderScene(t,s,h,i,a,o,r=!1){this.clear(),this.renderBackground(),t.render(this.ctx),s.render(this.ctx),h.render(this.ctx),i.render(this.ctx),this.renderScoreboard(a,o),this.renderPlayerNames(),r&&this.renderServeHint()}}class U{constructor(t,s,h,i,a="j",o="k"){n(this,"left",!1);n(this,"right",!1);n(this,"jump",!1);n(this,"hit",!1);n(this,"upward",!1);n(this,"downward",!1);n(this,"keys",new Set);this.leftKey=t,this.rightKey=s,this.jumpKey=h,this.hitKey=i,this.upwardKey=a,this.downwardKey=o,this.setupListeners()}setupListeners(){window.addEventListener("keydown",t=>{this.keys.add(t.key.toLowerCase()),this.updateInputs()}),window.addEventListener("keyup",t=>{this.keys.delete(t.key.toLowerCase()),this.updateInputs()})}updateInputs(){this.left=this.keys.has(this.leftKey.toLowerCase()),this.right=this.keys.has(this.rightKey.toLowerCase()),this.jump=this.keys.has(this.jumpKey.toLowerCase()),this.hit=this.keys.has(this.hitKey.toLowerCase()),this.upward=this.keys.has(this.upwardKey.toLowerCase()),this.downward=this.keys.has(this.downwardKey.toLowerCase())}reset(){this.left=!1,this.right=!1,this.jump=!1,this.hit=!1,this.upward=!1,this.downward=!1}}class F{constructor(t=100){n(this,"left",!1);n(this,"right",!1);n(this,"jump",!1);n(this,"hit",!1);n(this,"upward",!1);n(this,"downward",!1);n(this,"lastActionTime",0);n(this,"reactionDelay");this.reactionDelay=t}predictBallTrajectory(t,s,h,i,a){let o=t,r=s,l=h,c=i;const y=.4,f=.98,g=450;for(let I=0;I<300;I++){if(c+=y,l*=f,c*=f,o+=l,r+=c,o>=450&&r>=200&&r<=420)return{x:o,y:r,time:I};if(r>=g)return{x:o,y:g,time:I}}return null}shouldHit(t,s,h,i,a,o){if(h<420)return{hit:!1,type:null};const r=Math.abs(h-t),l=Math.abs(i-s),c=70;if(r>c||l>c*2)return{hit:!1,type:null};const y=s-58;return t>750?{hit:!0,type:"upward"}:i>y-10?{hit:!0,type:"upward"}:Math.random()<.2||o>8?{hit:!0,type:"upward"}:{hit:!0,type:"downward"}}update(t,s,h,i,a,o,r,l){if(this.left=!1,this.right=!1,this.jump=!1,this.hit=!1,this.upward=!1,this.downward=!1,l-this.lastActionTime<this.reactionDelay)return;const c=h>r,y=a>0;if(c||y){const f=this.predictBallTrajectory(h,i,a,o,t);if(f){const u=f.x-25-t;Math.abs(u)>15&&(u>0?this.right=!0:this.left=!0);const T=s-80,S=s-40;f.y<S&&f.y>T&&f.time<25&&(this.jump=!0,this.lastActionTime=l)}else{const p=h+a*15-t;Math.abs(p)>20&&(p>0?this.right=!0:this.left=!0)}const g=this.shouldHit(t,s,h,i,a,o);g.hit&&(g.type==="upward"?this.upward=!0:g.type==="downward"&&(this.downward=!0),this.lastActionTime=l)}}reset(){this.left=!1,this.right=!1,this.jump=!1,this.hit=!1,this.upward=!1,this.downward=!1}}var P=(d=>(d[d.UPWARD=0]="UPWARD",d[d.DOWNWARD=1]="DOWNWARD",d))(P||{});class D{constructor(t,s){n(this,"x");n(this,"y");n(this,"vx",0);n(this,"vy",0);n(this,"width",e.PLAYER_WIDTH);n(this,"height",e.PLAYER_HEIGHT);n(this,"side");n(this,"color");n(this,"animationTime",0);n(this,"isSwinging",!1);n(this,"swingProgress",0);n(this,"hitCooldown",0);n(this,"isOnGround",!0);n(this,"isServingMode",!1);n(this,"isServingAnimation",!1);n(this,"servingProgress",0);n(this,"onServeReady",null);n(this,"swingType",0);n(this,"hasHitInThisSwing",!1);n(this,"hasHitInReturn",!1);this.x=t,this.y=e.GROUND_Y,this.side=s,this.color=s===A.LEFT?"#000000":"#FF0000"}update(t){t.left?this.vx=-5:t.right?this.vx=e.PLAYER_SPEED:this.vx=0,this.x+=this.vx;const s=e.NET_X,h=12;if(this.side===A.LEFT?this.x>s-h&&(this.x=s-h,this.vx=0):this.x<s+h&&(this.x=s+h,this.vx=0),this.x<e.LEFT_BOUNDARY&&(this.x=e.LEFT_BOUNDARY),this.x>e.RIGHT_BOUNDARY&&(this.x=e.RIGHT_BOUNDARY),this.side===A.LEFT?this.x>e.SERVICE_LINE_LEFT&&(this.x=e.SERVICE_LINE_LEFT,this.vx=0):this.x<e.SERVICE_LINE_RIGHT&&(this.x=e.SERVICE_LINE_RIGHT,this.vx=0),t.jump&&this.isOnGround&&(this.vy=-14,this.isOnGround=!1),this.isOnGround||(this.vy+=e.GRAVITY,this.y+=this.vy,this.y>=e.GROUND_Y&&(this.y=e.GROUND_Y,this.vy=0,this.isOnGround=!0)),t.upward&&this.hitCooldown===0&&(this.swingType=0,this.isSwinging=!0,this.swingProgress=0,this.hasHitInThisSwing=!1,this.hasHitInReturn=!1,this.hitCooldown=e.SWING_UPWARD_DURATION),t.downward&&this.hitCooldown===0&&(this.swingType=1,this.isSwinging=!0,this.swingProgress=0,this.hasHitInThisSwing=!1,this.hasHitInReturn=!1,this.hitCooldown=e.SWING_DOWNWARD_DURATION),this.isSwinging){this.swingProgress++;const i=this.swingType===0?e.SWING_UPWARD_DURATION:e.SWING_DOWNWARD_DURATION;this.swingProgress>=i&&(this.isSwinging=!1,this.swingProgress=0,this.hasHitInReturn=!1)}this.hitCooldown>0&&this.hitCooldown--,this.isServingAnimation&&(this.servingProgress++,this.servingProgress===Math.floor(e.SERVING_ANIMATION_DURATION/2)&&this.onServeReady&&this.onServeReady(),this.servingProgress>=e.SERVING_ANIMATION_DURATION&&(this.isServingAnimation=!1,this.servingProgress=0,this.isServingMode=!1,this.onServeReady=null)),Math.abs(this.vx)>.1&&(this.animationTime+=e.LEG_ANIMATION_SPEED)}isInReturnPhase(){if(!this.isSwinging)return!1;const t=this.swingType===0?e.SWING_UPWARD_DURATION:e.SWING_DOWNWARD_DURATION;return this.swingProgress>t/2}render(t){const s=e.GROUND_Y,h=Math.max(0,s-this.y),i=Math.max(.4,1-h/150);t.fillStyle=`rgba(0,0,0,${.2*i})`,t.beginPath(),t.ellipse(this.x,s,15*i,6*i,0,0,Math.PI*2),t.fill(),t.strokeStyle=this.color,t.lineWidth=4,t.lineCap="round",t.lineJoin="round";const a=14,o=32,r=32,l=24,c=this.y,y=c-r,f=y-o,g=f-a,I=this.x;t.beginPath(),t.moveTo(this.x,f),t.lineTo(this.x,y),t.stroke();const p=Math.sin(this.animationTime)*18;t.beginPath(),t.moveTo(this.x,y);const u=this.x+p*.4,T=y+r*.5,S=this.x+p,v=c;t.quadraticCurveTo(u,T,S,v),t.stroke(),t.beginPath(),t.moveTo(this.x,y);const R=this.x-p*.4,w=y+r*.5,m=this.x-p,b=c;t.quadraticCurveTo(R,w,m,b),t.stroke();const N=f+5;this.renderArms(t,N,l),t.fillStyle="#FFFFFF",t.beginPath(),t.arc(I,g,a,0,Math.PI*2),t.fill(),t.lineWidth=3,t.stroke(),t.fillStyle="#000000";const E=a*2.4,k=6,M=a*1.6,L=a*1.8,O=g-a;t.save(),t.translate(I,O),t.rotate(-.1*(this.side===A.LEFT?1:-1)),t.beginPath(),t.rect(-M/2,-L,M,L),t.fill(),t.beginPath(),t.rect(-E/2,-2,E,k),t.fill(),t.restore()}renderArms(t,s,h){if(t.strokeStyle=this.color,t.lineWidth=4,this.isServingMode){if(this.side===A.LEFT){const g=Math.PI/6,I=this.x+Math.cos(g)*h*1.3,p=s+Math.sin(g)*h*1.3;t.beginPath(),t.moveTo(this.x,s),t.lineTo(I,p),t.stroke(),this.renderHandBall(t,I,p);let u;if(this.isServingAnimation){const v=this.servingProgress/e.SERVING_ANIMATION_DURATION,R=Math.PI-Math.PI/4,w=Math.PI/6;u=R-(R-w)*v}else u=Math.PI-Math.PI/4;const T=this.x+Math.cos(u)*h,S=s+Math.sin(u)*h;t.beginPath(),t.moveTo(this.x,s),t.lineTo(T,S),t.stroke(),this.renderRacket(t,T,S,u)}else{const g=Math.PI-Math.PI/6,I=this.x+Math.cos(g)*h*1.3,p=s+Math.sin(g)*h*1.3;t.beginPath(),t.moveTo(this.x,s),t.lineTo(I,p),t.stroke(),this.renderHandBall(t,I,p);let u;if(this.isServingAnimation){const v=this.servingProgress/e.SERVING_ANIMATION_DURATION,R=Math.PI/4,w=Math.PI-Math.PI/6;u=R+(w-R)*v}else u=Math.PI/4;const T=this.x+Math.cos(u)*h,S=s+Math.sin(u)*h;t.beginPath(),t.moveTo(this.x,s),t.lineTo(T,S),t.stroke(),this.renderRacket(t,T,S,u)}return}const i=-Math.PI/6,a=this.x+Math.cos(i)*h*(this.side===A.LEFT?1:-1),o=s+Math.sin(i)*h;t.beginPath(),t.moveTo(this.x,s),t.lineTo(a,o),t.stroke();let r;if(this.isSwinging){const g=this.swingType===0?e.SWING_UPWARD_DURATION:e.SWING_DOWNWARD_DURATION,I=this.swingProgress/g;if(this.swingType===0){const p=e.SWING_UPWARD_START,u=e.SWING_UPWARD_END;r=p+(u-p)*I}else{const p=e.SWING_DOWNWARD_START,u=e.SWING_DOWNWARD_END;r=p+(u-p)*I}this.side===A.RIGHT&&(r=Math.PI-r)}else this.side===A.LEFT?r=-Math.PI*3/4:r=-Math.PI/4;const l=this.x+Math.cos(r)*(h*.6),c=s+Math.sin(r)*(h*.6),y=this.x+Math.cos(r)*h,f=s+Math.sin(r)*h;t.beginPath(),t.moveTo(this.x,s),t.quadraticCurveTo(l,c,y,f),t.stroke(),this.renderRacket(t,y,f,r)}renderRacket(t,s,h,i){t.save(),t.translate(s,h),t.rotate(i+Math.PI/2);const a=12,o=36;t.strokeStyle="#000",t.lineWidth=6,t.beginPath(),t.moveTo(0,0),t.lineTo(0,-15),t.stroke(),t.strokeStyle="#666",t.lineWidth=3,t.beginPath(),t.moveTo(0,-15),t.lineTo(0,-35),t.stroke(),t.translate(0,-53),t.strokeStyle="#333",t.lineWidth=3,t.beginPath(),t.ellipse(0,0,a/2,o/2,0,0,Math.PI*2),t.stroke(),t.save(),t.beginPath(),t.ellipse(0,0,a/2-1.5,o/2-1.5,0,0,Math.PI*2),t.clip(),t.strokeStyle="rgba(255, 255, 255, 0.4)",t.lineWidth=1;for(let r=-a/2;r<=a/2;r+=3)t.beginPath(),t.moveTo(r,-o/2),t.lineTo(r,o/2),t.stroke();for(let r=-o/2;r<=o/2;r+=3)t.beginPath(),t.moveTo(-a/2,r),t.lineTo(a/2,r),t.stroke();t.restore(),t.restore()}renderHandBall(t,s,h){}canHit(t,s){return Math.sqrt(Math.pow(t-this.x,2)+Math.pow(s-(this.y-this.height/2),2))<e.HIT_RANGE&&this.hitCooldown===0}getRacketPosition(){const o=this.y-32-32+5,r=24;let l;if(this.isSwinging){const p=this.swingType===0?e.SWING_UPWARD_DURATION:e.SWING_DOWNWARD_DURATION,u=this.swingProgress/p;if(this.swingType===0){const T=e.SWING_UPWARD_START,S=e.SWING_UPWARD_END;l=T+(S-T)*u}else{const T=e.SWING_DOWNWARD_START,S=e.SWING_DOWNWARD_END;l=T+(S-T)*u}this.side===A.RIGHT&&(l=Math.PI-l)}else this.side===A.LEFT?l=-Math.PI*3/4:l=-Math.PI/4;const c=this.x+Math.cos(l)*r,y=o+Math.sin(l)*r,f=51,g=c+Math.cos(l)*f,I=y+Math.sin(l)*f;return{x:g,y:I}}getRacketCollisionData(){const o=this.y-32-32+5,r=24;let l;if(this.isSwinging){const m=this.swingType===0?e.SWING_UPWARD_DURATION:e.SWING_DOWNWARD_DURATION,b=this.swingProgress/m;if(this.swingType===0){const N=e.SWING_UPWARD_START,E=e.SWING_UPWARD_END;l=N+(E-N)*b}else{const N=e.SWING_DOWNWARD_START,E=e.SWING_DOWNWARD_END;l=N+(E-N)*b}this.side===A.RIGHT&&(l=Math.PI-l)}else this.side===A.LEFT?l=-Math.PI*3/4:l=-Math.PI/4;const c=this.x+Math.cos(l)*r,y=o+Math.sin(l)*r,f=l+Math.PI/2,g=e.RACKET_HANDLE_LENGTH,I=e.RACKET_SHAFT_LENGTH,p=c+Math.cos(l)*g,u=y+Math.sin(l)*g,T=c+Math.cos(l)*(g+I),S=y+Math.sin(l)*(g+I),v=g+I+e.RACKET_HEAD_HEIGHT/2,R=c+Math.cos(l)*v,w=y+Math.sin(l)*v;return{frame:{centerX:R,centerY:w,width:e.RACKET_HEAD_WIDTH,height:e.RACKET_HEAD_HEIGHT,angle:f},shaft:{startX:p,startY:u,endX:T,endY:S,radius:e.RACKET_SHAFT_RADIUS},handle:{startX:c,startY:y,endX:p,endY:u,radius:3}}}getBallHandPosition(){const r=this.y-32-32+5,l=this.side===A.LEFT?1:-1,c=Math.PI/6,y=this.x+Math.cos(c)*24*1.3*l,f=r+Math.sin(c)*24*1.3;return{x:y,y:f}}getBallHeightRelativeToPlayer(t){const o=this.y-32-32;return t>o?"low":"high"}setSwingType(t){const s=this.getBallHeightRelativeToPlayer(t);this.swingType=s==="low"?0:1}}class B{constructor(t,s){n(this,"x");n(this,"y");n(this,"vx",0);n(this,"vy",0);n(this,"radius",e.BALL_RADIUS);n(this,"trail",[]);n(this,"trailLength",8);n(this,"ballImage",null);this.x=t,this.y=s}setBallImage(t){this.ballImage=t}update(){this.vy+=e.BALL_GRAVITY,this.vx*=e.BALL_AIR_RESISTANCE,this.vy*=e.BALL_AIR_RESISTANCE,this.x+=this.vx,this.y+=this.vy,this.trail.unshift({x:this.x,y:this.y,alpha:1}),this.trail.length>this.trailLength&&this.trail.pop(),this.trail.forEach((t,s)=>{t.alpha=1-s/this.trailLength}),this.x-this.radius<e.BOUNDARY_LEFT&&(this.x=e.BOUNDARY_LEFT+this.radius,this.vx=Math.abs(this.vx)*.5),this.x+this.radius>e.BOUNDARY_RIGHT&&(this.x=e.BOUNDARY_RIGHT-this.radius,this.vx=-Math.abs(this.vx)*.5),this.y-this.radius<e.BOUNDARY_TOP&&(this.y=e.BOUNDARY_TOP+this.radius,this.vy=Math.abs(this.vy)*.5),this.checkNetCollision()}checkNetCollision(){const t=e.NET_X,s=e.NET_BASE_Y-e.NET_HEIGHT,h=e.NET_BASE_Y,i=15;this.y-this.radius<=h&&this.y+this.radius>=s&&(this.vx>0&&this.x+this.radius>=t-i/2&&this.x-this.radius<=t?(this.x=t-i/2-this.radius,this.vx=-this.vx*.6,this.vy*=.8):this.vx<0&&this.x-this.radius<=t+i/2&&this.x+this.radius>=t&&(this.x=t+i/2+this.radius,this.vx=-this.vx*.6,this.vy*=.8)),this.vy>0&&Math.abs(this.x-t)<=i/2+this.radius&&this.y-this.radius<=s&&this.y+this.radius>=s-5&&(this.y=s-this.radius,this.vy=-this.vy*.5,this.vx*=.7)}hit(t,s,h,i,a,o=!1){if(o){console.log("‰∏äÊåëÂáªÁêÉÔºÅ(IsUpward flag)","direction:",i);const f=-Math.PI/4,g=25*.7;i===1?(this.vx=Math.cos(f)*g,this.vy=Math.sin(f)*g):(this.vx=-Math.cos(f)*g,this.vy=Math.sin(f)*g),this.trail=[];return}let c=a;i===-1&&(c=-a),c+=-.424,this.vx=Math.cos(c)*25*i*.7,this.vy=Math.sin(c)*25*.7,this.trail=[]}serve(t,s,h){this.x=t,this.y=s,this.vx=11*h,this.vy=-18,this.trail=[]}isOnGround(){return this.y>=e.BALL_GROUND_Y}reset(t,s){this.x=t,this.y=s,this.vx=0,this.vy=0,this.trail=[]}render(t){this.trail.forEach((i,a)=>{a!==0&&(t.beginPath(),t.arc(i.x,i.y,this.radius*.4,0,Math.PI*2),t.fillStyle=`rgba(255, 255, 255, ${i.alpha*.2})`,t.fill())}),t.save(),t.translate(this.x,this.y);let s=0;Math.abs(this.vx)>.1||Math.abs(this.vy)>.1?s=Math.atan2(this.vy,this.vx):s=Math.PI/2;const h=Math.PI*5/4;if(t.rotate(s+h),this.ballImage){const a=this.radius*5/this.ballImage.width,o=this.ballImage.width*a,r=this.ballImage.height*a;t.drawImage(this.ballImage,-o/2,-r/2,o,r)}else{const i=this.radius*.8;t.beginPath(),t.arc(0,0,i,-Math.PI/2,Math.PI/2),t.fillStyle="#8B0000",t.fill(),t.strokeStyle="#333",t.lineWidth=1,t.stroke();const a=this.radius*1.8,o=i*1.8,r=this.radius*2.2;t.beginPath(),t.moveTo(0,-o/2),t.lineTo(-a,-r/2),t.ellipse(-a,0,a*.1,r/2,0,Math.PI/2,3*Math.PI/2),t.lineTo(0,o/2),t.closePath(),t.fillStyle="rgba(255, 255, 255, 0.9)",t.fill(),t.strokeStyle="#DDD",t.lineWidth=1,t.stroke()}t.restore()}getSpeed(){return Math.sqrt(this.vx*this.vx+this.vy*this.vy)}checkRacketCollision(t,s=!1){const h=s?20:0;return this.checkEllipseCollision(t.frame.centerX,t.frame.centerY,t.frame.width/2,t.frame.height/2,t.frame.angle,h)||this.checkLineSegmentCollision(t.shaft.startX,t.shaft.startY,t.shaft.endX,t.shaft.endY,t.shaft.radius)?!0:this.checkLineSegmentCollision(t.handle.startX,t.handle.startY,t.handle.endX,t.handle.endY,t.handle.radius)}checkEllipseCollision(t,s,h,i,a,o=0){const r=this.x-t,l=this.y-s,c=Math.cos(-a),y=Math.sin(-a),f=r*c-l*y,g=r*y+l*c,I=this.radius+o,p=h+I,u=i+I;return f*f/(p*p)+g*g/(u*u)<=1}checkLineSegmentCollision(t,s,h,i,a){const o=h-t,r=i-s,l=o*o+r*r;if(l===0)return Math.pow(this.x-t,2)+Math.pow(this.y-s,2)<=Math.pow(this.radius+a,2);let c=((this.x-t)*o+(this.y-s)*r)/l;c=Math.max(0,Math.min(1,c));const y=t+c*o,f=s+c*r;return Math.pow(this.x-y,2)+Math.pow(this.y-f,2)<=Math.pow(this.radius+a,2)}}class X{constructor(t,s){n(this,"x");n(this,"y");n(this,"vx");n(this,"vy");n(this,"life");n(this,"maxLife");n(this,"size");n(this,"color");n(this,"rotation");n(this,"rotationSpeed");this.x=t,this.y=s,this.vx=(Math.random()-.5)*8,this.vy=(Math.random()-.5)*8-2,this.life=e.PARTICLE_LIFETIME,this.maxLife=e.PARTICLE_LIFETIME,this.size=Math.random()*6+3,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.3;const h=["#FFD700","#FF6B6B","#4ECDC4","#45B7D1","#FFA07A","#98D8C8"];this.color=h[Math.floor(Math.random()*h.length)]}update(){this.x+=this.vx,this.y+=this.vy,this.vy+=.3,this.vx*=.99,this.rotation+=this.rotationSpeed,this.life--}isAlive(){return this.life>0}getAlpha(){return this.life/this.maxLife}}class K{constructor(){n(this,"particles",[])}emit(t,s,h=e.PARTICLE_COUNT){for(let i=0;i<h;i++)this.particles.push(new X(t,s))}update(){for(let t=this.particles.length-1;t>=0;t--)this.particles[t].update(),this.particles[t].isAlive()||this.particles.splice(t,1)}render(t){for(const s of this.particles){t.save(),t.globalAlpha=s.getAlpha(),t.translate(s.x,s.y),t.rotate(s.rotation),t.fillStyle=s.color;const h=s.size/2;t.fillRect(-h,-h,s.size,s.size),t.restore()}}clear(){this.particles=[]}}class V{constructor(t){n(this,"state",_.LOADING);n(this,"resourceManager");n(this,"renderer");n(this,"player1");n(this,"player2");n(this,"player1Input");n(this,"player2Input");n(this,"ball");n(this,"particles");n(this,"leftScore",0);n(this,"rightScore",0);n(this,"servingSide",A.LEFT);n(this,"isServing",!0);n(this,"waitingForServe",!1);n(this,"serveTimer",0);n(this,"lastTime",0);this.canvas=t,this.resourceManager=new G,this.renderer=new Y(t,this.resourceManager),this.player1=new D(e.PLAYER1_X,A.LEFT),this.player2=new D(e.PLAYER2_X,A.RIGHT),this.player1Input=new U("a","d","w","s"),this.player2Input=new F(e.AI_REACTION_DELAY),this.ball=new B(e.NET_X,e.BALL_INITIAL_Y),this.particles=new K,this.setupSpacebarListener()}async init(){this.resourceManager.loadImage("background","assets/bg.jpg"),this.resourceManager.loadImage("score_bg","assets/score_bg.png"),this.resourceManager.loadImage("ball","assets/ymq.png"),this.resourceManager.loadImage("label_bg","assets/bq.png"),await this.resourceManager.waitForAll();const t=this.resourceManager.getImage("ball");t&&this.ball.setBallImage(t),this.state=_.PLAYING;const s=document.getElementById("loading");s&&(s.style.display="none")}setupSpacebarListener(){window.addEventListener("keydown",t=>{t.code==="Space"&&this.state===_.GAME_OVER&&this.reset()})}start(){this.lastTime=performance.now(),this.gameLoop(this.lastTime)}gameLoop(t){if(requestAnimationFrame(s=>this.gameLoop(s)),this.state!==_.PLAYING){if(this.state===_.GAME_OVER){const s=this.leftScore>=e.WINNING_SCORE?"Áé©ÂÆ∂ 1":"AI";this.renderer.renderScene(this.player1,this.player2,this.ball,this.particles,this.leftScore,this.rightScore),this.renderer.renderGameOver(s)}return}this.update(t),this.render()}update(t){if(this.isServing){this.handleServe(),this.player1.update(this.player1Input),this.player2.update(this.player2Input),this.particles.update();return}this.player2Input.update(this.player2.x,this.player2.y,this.ball.x,this.ball.y,this.ball.vx,this.ball.vy,e.NET_X,t),this.player1Input.hit&&this.player1.hitCooldown===0&&this.player1.setSwingType(this.ball.y),this.player2Input.hit&&this.player2.hitCooldown===0&&this.player2.setSwingType(this.ball.y),this.player1.update(this.player1Input),this.player2.update(this.player2Input),this.ball.update(),this.particles.update(),this.checkHit(),this.checkScoring()}handleServe(){if(this.servingSide===A.LEFT){this.waitingForServe||(this.waitingForServe=!0,this.ball.reset(this.player1.x,e.GROUND_Y-this.ball.radius)),this.player1.isServingMode=!0,this.player2.isServingMode=!1;const s=this.player1.getBallHandPosition();this.ball.x=s.x,this.ball.y=s.y,this.ball.vx=0,this.ball.vy=0,this.player1Input.hit&&!this.player1.isServingAnimation&&(this.player1.isServingAnimation=!0,this.player1.servingProgress=0,this.player1.onServeReady=()=>{this.ball.serve(this.ball.x,this.ball.y,1),this.isServing=!1,this.waitingForServe=!1})}else{this.waitingForServe||(this.waitingForServe=!0,this.serveTimer=0,this.ball.reset(this.player2.x,e.GROUND_Y-this.ball.radius)),this.player1.isServingMode=!1,this.player2.isServingMode=!0,this.serveTimer++;const s=this.player2.getBallHandPosition();this.ball.x=s.x,this.ball.y=s.y,this.ball.vx=0,this.ball.vy=0,this.serveTimer>60&&(this.player2.isServingAnimation||(this.player2.isServingAnimation=!0,this.player2.servingProgress=0,this.player2.onServeReady=()=>{this.ball.serve(this.ball.x,this.ball.y,-1),this.isServing=!1,this.waitingForServe=!1}))}}checkHit(){if(this.player1.isSwinging){const t=this.player1.getRacketCollisionData(),s=this.player1.swingType===P.UPWARD;if(this.ball.checkRacketCollision(t,s)){const h=this.player1.isInReturnPhase();if(!h&&!this.player1.hasHitInThisSwing){const i=t.frame.angle;this.ball.hit(this.player1.x,this.player1.y,this.player1.height,1,i,s),this.ball.getSpeed()>14&&this.particles.emit(this.ball.x,this.ball.y,6),this.player1.hasHitInThisSwing=!0}else if(h&&!this.player1.hasHitInReturn){const i=t.frame.angle;this.ball.hit(this.player1.x,this.player1.y,this.player1.height,1,i,s),this.ball.getSpeed()>14&&this.particles.emit(this.ball.x,this.ball.y,6),this.player1.hasHitInReturn=!0}}}if(this.player2.isSwinging){const t=this.player2.getRacketCollisionData(),s=this.player2.swingType===P.UPWARD;if(this.ball.checkRacketCollision(t,s)){const h=this.player2.isInReturnPhase();if(!h&&!this.player2.hasHitInThisSwing){const i=t.frame.angle;this.ball.hit(this.player2.x,this.player2.y,this.player2.height,-1,i,s),this.ball.getSpeed()>14&&this.particles.emit(this.ball.x,this.ball.y,6),this.player2.hasHitInThisSwing=!0}else if(h&&!this.player2.hasHitInReturn){const i=t.frame.angle;this.ball.hit(this.player2.x,this.player2.y,this.player2.height,-1,i,s),this.ball.getSpeed()>14&&this.particles.emit(this.ball.x,this.ball.y,6),this.player2.hasHitInReturn=!0}}}}checkScoring(){this.ball.isOnGround()&&(this.ball.x<e.NET_X?(this.rightScore++,this.servingSide=A.RIGHT):(this.leftScore++,this.servingSide=A.LEFT),this.particles.emit(this.ball.x,this.ball.y,e.PARTICLE_COUNT),this.leftScore>=e.WINNING_SCORE||this.rightScore>=e.WINNING_SCORE?this.state=_.GAME_OVER:this.prepareServe())}prepareServe(){this.isServing=!0,this.waitingForServe=!1,this.ball.reset(e.NET_X,e.BALL_INITIAL_Y)}render(){const t=this.isServing&&this.servingSide===A.LEFT;this.renderer.renderScene(this.player1,this.player2,this.ball,this.particles,this.leftScore,this.rightScore,t)}reset(){this.leftScore=0,this.rightScore=0,this.servingSide=A.LEFT,this.prepareServe(),this.particles.clear(),this.state=_.PLAYING}}const H=document.getElementById("gameCanvas");if(!H)throw new Error("Canvas element not found!");const W=new V(H);W.init().then(()=>{console.log("üéÆ Ê∏∏ÊàèÂàùÂßãÂåñÂÆåÊàêÔºÅ"),W.start()}).catch(d=>{console.error("‚ùå Ê∏∏ÊàèÂàùÂßãÂåñÂ§±Ë¥•:",d)});
